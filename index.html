<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•ªèŒ„åœ’é»æ­Œç³»çµ± â™ª - Firebase åŒæ­¥ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        /* ä¿ç•™ä½ åŸæœ¬å„ªç¾çš„ç²‰è‰²èª¿ CSS */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', 'Poppins', sans-serif; background: linear-gradient(135deg, #FFF8F3 0%, #FFE8F0 100%); color: #5A4A4A; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #FFB6D9 0%, #D4B5F0 100%); border-radius: 0 0 30px 30px; box-shadow: 0 4px 20px rgba(255, 182, 217, 0.3); margin-bottom: 30px; color: white; }
        .mode-switch { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .mode-btn { background: linear-gradient(135deg, #FFB6D9 0%, #D4B5F0 100%); color: white; border: none; padding: 15px 25px; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 182, 217, 0.4); transition: all 0.3s ease; font-weight: 600; }
        .filter-section { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .filter-btn { padding: 8px 18px; border: 2px solid #FFB6D9; background: white; color: #FFB6D9; border-radius: 25px; cursor: pointer; margin: 5px; transition: all 0.3s; }
        .filter-btn.active { background: #FFB6D9; color: white; }
        .songs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .song-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: 2px solid transparent; transition: all 0.3s; }
        .song-card:hover { transform: translateY(-5px); border-color: #FFB6D9; }
        .tag { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; margin-right: 5px; background: #FFE8F0; color: #FFB6D9; }
        .queue-section { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .status-singing { background: #FFE8F0; color: #FFB6D9; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 25px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .form-input, .form-textarea { width: 100%; padding: 12px; border: 2px solid #F0E8FF; border-radius: 12px; margin-top: 5px; outline: none; }
        .btn-primary { background: linear-gradient(135deg, #FFB6D9 0%, #D4B5F0 100%); color: white; width: 100%; padding: 12px; border-radius: 15px; font-weight: 600; margin-top: 10px; border: none; cursor: pointer; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: white; padding: 12px 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 3000; display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤ ç•ªèŒ„åœ’é»æ­Œç³»çµ± â™ª</h1>
        <p>è³‡æ–™å·²å³æ™‚é€£ç·šé›²ç«¯ â™¡</p>
    </div>

    <div class="container">
        <div id="audienceView">
            <div class="filter-section">
                <div id="filterButtons">
                    <button class="filter-btn active" onclick="setFilter('all')">å…¨éƒ¨æ­Œæ›²</button>
                    <button class="filter-btn" onclick="setFilter('ä¸­æ–‡')">ä¸­æ–‡æ­Œ</button>
                    <button class="filter-btn" onclick="setFilter('æ—¥æ–‡')">æ—¥æ–‡æ­Œ</button>
                    <button class="filter-btn" onclick="setFilter('æŠ’æƒ…')">æŠ’æƒ…</button>
                </div>
            </div>

            <div class="queue-section">
                <h3 class="font-bold mb-4">ğŸµ æ’éšŠä¸­</h3>
                <div id="queueList">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="songs-grid" id="songsGrid"></div>
        </div>

        <div id="managementView" style="display:none;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">ç®¡ç†æ¨¡å¼ ğŸ”§</h2>
                <button class="bg-green-400 text-white px-4 py-2 rounded-xl" onclick="openSongModal()">æ–°å¢æ­Œæ›² +</button>
            </div>
            <div class="queue-section">
                <h3 class="font-bold mb-4">ğŸ“‹ é»æ­Œç®¡ç†</h3>
                <div id="adminQueueList"></div>
            </div>
            <div id="adminSongsList"></div>
        </div>
    </div>

    <div class="mode-switch">
        <button class="mode-btn" onclick="toggleMode()">åˆ‡æ›æ¨¡å¼ ğŸ”§</button>
    </div>

    <div class="modal" id="requestModal">
        <div class="modal-content" id="requestModalContent"></div>
    </div>

    <div class="modal" id="songModal">
        <div class="modal-content" id="songModalContent"></div>
    </div>

    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">è¼¸å…¥ç®¡ç†å¯†ç¢¼ ğŸ”’</h3>
            <input type="password" id="adminPwd" class="form-input" placeholder="é è¨­å¯†ç¢¼ admin">
            <button class="btn-primary" onclick="verifyAdmin()">é€²å…¥</button>
            <button class="w-full mt-2 text-gray-400" onclick="closeModals()">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // --- Firebase åˆå§‹åŒ– ---
        const firebaseConfig = {
            apiKey: "AIzaSyAZr1jc23-EdgzDxUVMdRn-ROZ8ZWS_L5k",
            authDomain: "vtuber-ktv.firebaseapp.com",
            projectId: "vtuber-ktv",
            storageBucket: "vtuber-ktv.firebasestorage.app",
            messagingSenderId: "570327519718",
            appId: "1:570327519718:web:0db4c15b94e7cad34a0627",
            databaseURL: "https://vtuber-ktv-default-rtdb.firebaseio.com/" // è«‹ç¢ºèªæ­¤ç¶²å€æ­£ç¢º
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let songs = [];
        let queue = [];
        let isManagementMode = false;
        let currentFilter = 'all';

        // --- è³‡æ–™åŒæ­¥ï¼šå³æ™‚ç›£è½ ---
        db.ref('songs').on('value', snapshot => {
            const data = snapshot.val();
            songs = data ? Object.keys(data).map(key => ({...data[key], id: key})) : [];
            renderAll();
        });

        db.ref('queue').on('value', snapshot => {
            const data = snapshot.val();
            queue = data ? Object.keys(data).map(key => ({...data[key], id: key})) : [];
            renderAll();
        });

        function renderAll() {
            renderSongs();
            renderQueue();
            if(isManagementMode) {
                renderAdminQueue();
                renderAdminSongs();
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ ---
        function renderSongs() {
            const grid = document.getElementById('songsGrid');
            let displaySongs = songs.filter(s => !s.isHidden);
            
            if(currentFilter !== 'all') {
                displaySongs = displaySongs.filter(s => 
                    Object.values(s.categories || {}).flat().includes(currentFilter)
                );
            }

            grid.innerHTML = displaySongs.map(s => `
                <div class="song-card">
                    <div class="text-lg font-bold">${s.name}</div>
                    <div class="text-gray-400 text-sm mb-2">${s.artist || ''}</div>
                    <div class="mb-4">${(s.categories?.language || []).map(t => `<span class="tag">${t}</span>`).join('')}</div>
                    <button class="btn-primary ${s.isAvailable ? '' : 'opacity-50'}" 
                        onclick="openRequestModal('${s.id}')" ${s.isAvailable ? '' : 'disabled'}>
                        ${s.isAvailable ? 'é»æ­Œ â™ª' : 'æš«ä¸é–‹æ”¾'}
                    </button>
                </div>
            `).join('');
        }

        function renderQueue() {
            const list = document.getElementById('queueList');
            const activeQueue = queue.filter(q => q.status !== 'completed' && q.status !== 'skipped');
            if(activeQueue.length === 0) { list.innerHTML = "ç›®å‰æ²’äººé»æ­Œå”·ï½"; return; }
            
            list.innerHTML = activeQueue.map((q, i) => `
                <div class="flex justify-between items-center p-3 bg-pink-50 rounded-lg mb-2">
                    <div>
                        <span class="font-bold">${i+1}. ${q.songName}</span>
                        <div class="text-xs text-gray-400">${q.requester || 'åŒ¿å'} ${q.message ? 'Â· '+q.message : ''}</div>
                    </div>
                    <span class="px-2 py-1 rounded text-xs ${q.status==='singing'?'status-singing':'bg-gray-200'}">
                        ${q.status==='singing'?'æ¼”å”±ä¸­ ğŸ¤':'æ’éšŠä¸­'}
                    </span>
                </div>
            `).join('');
        }

        // --- é»æ­Œé‚è¼¯ ---
        function openRequestModal(songId) {
            const song = songs.find(s => s.id === songId);
            const modal = document.getElementById('requestModal');
            document.getElementById('requestModalContent').innerHTML = `
                <h2 class="text-xl font-bold mb-2">é»æ­Œï¼š${song.name}</h2>
                <input type="text" id="reqName" class="form-input" placeholder="ä½ çš„åå­—">
                <textarea id="reqMsg" class="form-textarea" placeholder="æƒ³èªªçš„è©±"></textarea>
                <button class="btn-primary" onclick="submitRequest('${songId}', '${song.name}')">é€å‡ºé»æ­Œ</button>
                <button class="w-full mt-2" onclick="closeModals()">å–æ¶ˆ</button>
            `;
            modal.classList.add('active');
        }

        function submitRequest(songId, songName) {
            const requester = document.getElementById('reqName').value;
            const message = document.getElementById('reqMsg').value;
            db.ref('queue').push({
                songId, songName, requester, message,
                status: 'queued',
                time: Date.now()
            });
            closeModals();
            showToast("é»æ­ŒæˆåŠŸï¼");
        }

        // --- ç®¡ç†åŠŸèƒ½ ---
        function toggleMode() {
            if(!isManagementMode) document.getElementById('passwordModal').classList.add('active');
            else {
                isManagementMode = false;
                document.getElementById('managementView').style.display = 'none';
                document.getElementById('audienceView').style.display = 'block';
            }
        }

        function verifyAdmin() {
            if(document.getElementById('adminPwd').value === 'admin') {
                isManagementMode = true;
                document.getElementById('passwordModal').classList.remove('active');
                document.getElementById('managementView').style.display = 'block';
                document.getElementById('audienceView').style.display = 'none';
                renderAdminQueue();
                renderAdminSongs();
            } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
        }

        function updateStatus(qid, status) {
            db.ref(`queue/${qid}`).update({ status });
            if(status === 'completed') {
                const qItem = queue.find(q => q.id === qid);
                const song = songs.find(s => s.id === qItem.songId);
                if(song) db.ref(`songs/${song.id}`).update({ 
                    sungCount: (song.sungCount || 0) + 1,
                    lastSungDate: new Date().toISOString().split('T')[0]
                });
            }
        }

        function renderAdminQueue() {
            const list = document.getElementById('adminQueueList');
            list.innerHTML = queue.filter(q => q.status !== 'completed').map(q => `
                <div class="border-b p-3 flex justify-between">
                    <div><b>${q.songName}</b> (${q.requester || 'åŒ¿å'})</div>
                    <div>
                        <button onclick="updateStatus('${q.id}', 'singing')" class="text-blue-500 mr-2">æ¼”å”±ä¸­</button>
                        <button onclick="updateStatus('${q.id}', 'completed')" class="text-green-500 mr-2">å®Œå”±</button>
                        <button onclick="db.ref('queue/${q.id}').remove()" class="text-red-400">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function renderAdminSongs() {
            const list = document.getElementById('adminSongsList');
            list.innerHTML = songs.map(s => `
                <div class="p-3 border-b flex justify-between items-center bg-white mb-1 rounded">
                    <span>${s.name}</span>
                    <button class="text-sm text-gray-400" onclick="db.ref('songs/${s.id}').update({isHidden: !s.isHidden})">
                        ${s.isHidden ? 'é¡¯ç¤º' : 'éš±è—'}
                    </button>
                </div>
            `).join('');
        }

        function openSongModal() {
            const modal = document.getElementById('songModal');
            document.getElementById('songModalContent').innerHTML = `
                <h2 class="text-xl font-bold mb-4">æ–°å¢æ­Œæ›²</h2>
                <input type="text" id="newSongName" class="form-input" placeholder="æ­Œæ›²åç¨±">
                <input type="text" id="newArtist" class="form-input" placeholder="æ­Œæ‰‹">
                <input type="text" id="newLang" class="form-input" placeholder="èªè¨€ (å¦‚ï¼šä¸­æ–‡)">
                <button class="btn-primary" onclick="addSong()">ç¢ºèªæ–°å¢</button>
                <button class="w-full mt-2" onclick="closeModals()">å–æ¶ˆ</button>
            `;
            modal.classList.add('active');
        }

        function addSong() {
            const name = document.getElementById('newSongName').value;
            const artist = document.getElementById('newArtist').value;
            const lang = document.getElementById('newLang').value;
            if(!name) return;
            db.ref('songs').push({
                name, artist, 
                categories: { language: [lang] },
                isAvailable: true,
                isHidden: false,
                sungCount: 0
            });
            closeModals();
        }

        // --- è¼”åŠ©å·¥å…· ---
        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderSongs();
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function generateId() { return Date.now().toString(36); }
    </script>
</body>
</html>


